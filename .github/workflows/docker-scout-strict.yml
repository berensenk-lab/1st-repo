name: Docker Scout - Strict CVE Check

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  scout-strict-check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - 'almosega/minikube:patched'
          - 'almosega/open-webui:patched'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: docker pull ${{ matrix.image }}

      - name: Generate safe filename
        id: filename
        run: |
          SAFE_NAME=$(echo "${{ matrix.image }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT

      - name: Docker Scout CVE Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ matrix.image }}
          sarif-file: sarif-${{ steps.filename.outputs.safe_name }}.json
          summary: true
          write-comment: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          exit-code: true
          only-severities: critical,high

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: sarif-${{ steps.filename.outputs.safe_name }}.json
          category: docker-scout-strict-${{ steps.filename.outputs.safe_name }}

      - name: Create issue on CVE failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const image = '${{ matrix.image }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Critical/High CVEs found in ${image}`,
              body: `## ⚠️ Security Alert\n\n**Image:** \`${image}\`\n**Run:** ${runUrl}\n\nCritical or high severity CVEs were detected. Please review and remediate.\n\n### Next Steps:\n1. Review scan results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)\n2. Update base images and dependencies\n3. Rebuild and rescan the image\n4. Close this issue once resolved`,
              labels: ['security', 'cve', 'high-priority']
            });
