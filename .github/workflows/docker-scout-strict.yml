name: Docker Scout - Strict CVE Check

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  scout-strict-check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - 'almosega/minikube:patched'
          - 'almosega/open-webui:patched'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Pull Docker image
        run: docker pull ${{ matrix.image }}
      
      - name: Docker Scout CVE Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ matrix.image }}
          sarif-file: sarif-${{ matrix.image }}.json
          summary: true
          write-comment: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          exit-code: true
          only-severities: critical,high
      
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: sarif-${{ matrix.image }}.json
          category: docker-scout-strict-${{ matrix.image }}
      
      - name: Create issue on CVE failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const image = '${{ matrix.image }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Critical/High CVEs found in ${ image }`,
              body: `## Warning: Security Alert\n\n**Image:** ` + image + `\n**Run:** ` + runUrl + `\n\nCritical or high severity CVEs were detected.`,
              labels: ['security', 'cve', 'high-priority']
            });
