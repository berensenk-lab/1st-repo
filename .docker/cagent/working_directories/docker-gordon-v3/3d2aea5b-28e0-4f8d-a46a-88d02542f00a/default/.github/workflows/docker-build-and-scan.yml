name: Build and Scan Docker Images

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/Dockerfile*'
      - '.github/workflows/docker-build-and-scan.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/Dockerfile*'
  workflow_dispatch:

env:
  DOCKER_SCOUT_HUB_USER: ${{ secrets.DOCKER_SCOUT_HUB_USER }}
  DOCKER_SCOUT_HUB_PASSWORD: ${{ secrets.DOCKER_SCOUT_HUB_PASSWORD }}

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.DOCKER_SCOUT_HUB_USER != '' && env.DOCKER_SCOUT_HUB_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_SCOUT_HUB_USER }}
          password: ${{ secrets.DOCKER_SCOUT_HUB_PASSWORD }}

      - name: Find Dockerfiles
        id: find_dockerfiles
        run: |
          dockerfiles=$(find . -name 'Dockerfile*' -not -path '*/\.*' | head -5)
          echo "Found Dockerfiles:"
          echo "$dockerfiles"
          echo "dockerfiles<<EOF" >> $GITHUB_OUTPUT
          echo "$dockerfiles" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and scan images
        if: steps.find_dockerfiles.outputs.dockerfiles != ''
        run: |
          while IFS= read -r dockerfile; do
            if [ -z "$dockerfile" ]; then
              continue
            fi
            
            # Generate image name from path
            dir=$(dirname "$dockerfile")
            base=$(basename "$dockerfile" | sed 's/Dockerfile//' | sed 's/^\.//g' | tr '[:upper:]' '[:lower:]')
            image_name="local-scan/${dir##*/}${base:+:$base}"
            image_name=$(echo "$image_name" | tr '/' '-' | sed 's/^-//')
            
            echo "Building: $dockerfile as $image_name"
            
            # Build the image
            docker build -f "$dockerfile" -t "$image_name" "$dir" || {
              echo "Failed to build $dockerfile"
              continue
            }
            
            # Scan with Docker Scout
            echo "Scanning: $image_name"
            docker scout cves "$image_name" || echo "Scout scan failed for $image_name"
            
          done <<< "${{ steps.find_dockerfiles.outputs.dockerfiles }}"

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Docker Scout Scan Complete âœ…\n\nDocker images have been built and scanned for vulnerabilities. Check the workflow logs for detailed results.'
            })
