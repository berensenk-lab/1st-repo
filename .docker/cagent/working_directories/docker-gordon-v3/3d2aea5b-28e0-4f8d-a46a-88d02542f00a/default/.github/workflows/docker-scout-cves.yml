name: Docker Scout CVE Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  DOCKER_SCOUT_HUB_USER: ${{ secrets.DOCKER_SCOUT_HUB_USER }}
  DOCKER_SCOUT_HUB_PASSWORD: ${{ secrets.DOCKER_SCOUT_HUB_PASSWORD }}

jobs:
  scout-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - your-registry/minikube:patched
          - almosega/minikube:patched
          - minikube:patched
          - almosega/open-webui:patched
          - open-webui:patched
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.DOCKER_SCOUT_HUB_USER != '' && env.DOCKER_SCOUT_HUB_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_SCOUT_HUB_USER }}
          password: ${{ secrets.DOCKER_SCOUT_HUB_PASSWORD }}

      - name: Analyze image with Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ matrix.image }}
          sarif-file: sarif-${{ matrix.image }}.sarif
          summary: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: sarif-${{ matrix.image }}.sarif
          category: docker-scout-${{ matrix.image }}
